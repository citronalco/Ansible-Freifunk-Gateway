- name: ensure dependencies are installed.
  ansible.builtin.apt:
    name:
      - nginx
      - unzip
    state: present

- name: meshviewer-build.zip herunterladen
  ansible.builtin.get_url:
    url: https://github.com/freifunk/meshviewer/releases/download/{{ meshviewer.version }}/meshviewer-build.zip
    dest: /opt/meshviewer-{{ meshviewer.version }}.zip
    mode: '0644'
  register: meshviewer_download

- name: Verzeichnis /opt/meshviewer l√∂schen, wenn neuer Download erfolgt
  ansible.builtin.file:
    path: /opt/meshviewer
    state: absent
  when: meshviewer_download.changed

- name: create meshviewer directory if not existent
  ansible.builtin.file:
    path: /opt/meshviewer
    state: directory

- name: meshviewer-build.zip entpacken
  ansible.builtin.unarchive:
    src: /opt/meshviewer-{{ meshviewer.version }}.zip
    dest: /opt/meshviewer
    remote_src: yes
  when: meshviewer_download.changed

- name: Deploy config.json
  ansible.builtin.template:
    src: config.json.j2
    dest: /opt/meshviewer/config.json

- name: Clone device-pictures repo
  ansible.builtin.git:
    repo: https://github.com/freifunk/device-pictures.git
    dest: /opt/device-pictures
    update: yes

- name: create letsencrypt directory
  ansible.builtin.file:
    name: /var/www/letsencrypt
    state: directory

- name: Install default nginx site for letsencrypt requests and https rewrite
  ansible.builtin.template:
    src: templates/default.j2
    dest: /etc/nginx/sites-available/default
  register: gendefconf

- name: Activate default nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/default
    dest: /etc/nginx/sites-enabled/default
    state: link
  register: actdefconf

- name: Reload nginx to activate letsencrypt site
  ansible.builtin.service:
    name: nginx
    state: restarted
  when: gendefconf.changed or actdefconf.changed

- name: acme install
  ansible.builtin.shell: wget -O -  https://get.acme.sh | sh
  args:
    creates: /root/.acme.sh/acme.sh

- name: Create certificate
  ansible.builtin.shell: /root/.acme.sh/acme.sh --issue --server letsencrypt -d {{inventory_hostname_short}}.{{freifunk.domain}} -w /var/www/letsencrypt
  args:
    creates: /root/.acme.sh/{{inventory_hostname_short}}.{{freifunk.domain}}_ecc/ca.cer

- name: install cert to Nginx
  ansible.builtin.shell: /root/.acme.sh/acme.sh --installcert -d {{inventory_hostname_short}}.{{freifunk.domain}} --keypath "/etc/ssl/key.pem" --fullchainpath "/etc/ssl/fullchain.pem" --reloadcmd "systemctl restart nginx"
  args:
    creates: /etc/ssl/certs/key.pem
  
- name: Generate dhparams
  ansible.builtin.shell: openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
  args:
    creates: /etc/ssl/certs/dhparam.pem

- name: Create nginx caching dirs for tiles caching
  ansible.builtin.file:
    path: "{{item.path}}"
    state: directory
  with_items:
    - "{{nginx_tiles_cache.cache_locations}}"
  when: nginx_tiles_cache is defined and "cache_locations" in nginx_tiles_cache

- name: Define cache in nginx.conf
  ansible.builtin.lineinfile:
    regexp: "^[\t ]*proxy_cache_path.*mapserver"
    line: "\tproxy_cache_path /opt/mapserver_nginx_cache levels=1:2 keys_zone=mapserver:10m inactive=1h max_size=1g;"
    insertafter: "^[\t ]*http[\t ]*\\{"
    dest: /etc/nginx/nginx.conf
  notify:
    - restart nginx

- name: Define include for tiles cache in nginx.conf
  ansible.builtin.lineinfile:
    regexp: "^[\t ]*include /etc/nginx/tiles_cache.conf;"
    line: "\tinclude /etc/nginx/tiles_cache.conf;"
    insertafter: "^[\t ]*http[\t ]*\\{"
    dest: /etc/nginx/nginx.conf
  notify:
    - restart nginx
  when: nginx_tiles_cache is defined

- name: Deploy tiles_cache.conf
  ansible.builtin.template:
    src: tiles_cache.conf.j2
    dest: /etc/nginx/tiles_cache.conf
  notify:
    - restart nginx
  when: nginx_tiles_cache is defined

- name: Deploy default ssl nginx site
  ansible.builtin.template:
    src: default_ssl.j2
    dest: /etc/nginx/sites-available/default_ssl
  notify:
    - restart nginx

- name: Aktivate default ssl nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/default_ssl
    dest: /etc/nginx/sites-enabled/default_ssl
    state: link
  register: actsslconf

- name: Reload nginx to activate letsencrypt site
  ansible.builtin.service:
    name: nginx
    state: restarted
  when: actsslconf.changed

- name: link meshviewer
  ansible.builtin.file:
    src: /opt/meshviewer/
    dest: /var/www/html/map
    state: link

- name: link device-pictures
  ansible.builtin.file:
    src: /opt/device-pictures/pictures-svg/
    dest: /var/www/html/pictures-svg
    state: link
