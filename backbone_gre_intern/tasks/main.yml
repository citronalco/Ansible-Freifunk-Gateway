---
- name: Tunnels between backbones
  template: src="gre_interbackbone.j2" dest="/etc/network/interfaces.d/42_gre_interbackbone.cfg"
  notify: restart networking

- name: Gateways mit GRE-IP-Adressen in /etc/hosts eintragen
  blockinfile:
    path: "/etc/hosts"
    block: |
      {% for host in groups['gateways'] %}
      {% if host != inventory_hostname %}
      {% if hostvars[host].vm_id < vm_id %}
      192.168.{{  hostvars[host].vm_id-1  }}.{{ vm_id*2 }} {{ host }} {{ host }}.servers.{{ freifunk.domain }}
      {% else %}
      192.168.{{  vm_id-1  }}.{{ hostvars[host].vm_id*2+1 }} {{ host }} {{ host }}.servers.{{ freifunk.domain }}
      {% endif %}
      {% if hostvars[host].vm_id < vm_id %}
      {{ ipv6backbone64prefixstr }}{{ hostvars[host].vm_id }}:{{ vm_id }}:1  {{ host }} {{ host }}.servers.{{ freifunk.domain }}
      {% else %}
      {{ ipv6backbone64prefixstr }}{{ vm_id }}:{{ hostvars[host].vm_id }}:0  {{ host }} {{ host }}.servers.{{ freifunk.domain }}
      {% endif %}
      {% endif %}
      {% endfor %}

- name: Routingtabelle 42 auch ffnet nennen
  blockinfile:
    path: "/etc/iproute2/rt_tables"
    marker: "# {mark} Ansible managed block"
    block: |
      42   ffnet

#append line in interfaces file for reading additional config files
- name: let read interfaces.d from interfaces
  lineinfile: dest="/etc/network/interfaces" line="source /etc/network/interfaces.d/*"
  notify: restart networking
